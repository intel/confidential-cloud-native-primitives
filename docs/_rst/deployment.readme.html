<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CCNP Deployment Guide &mdash; Confidential Cloud-Native Primitives  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=b3ba4146"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Service: CCNP Eventlog Server" href="service.eventlog.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Confidential Cloud-Native Primitives
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="modules.html">CCNP Modules</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="modules.html#ccnp-sdk">CCNP SDK</a></li>
<li class="toctree-l2"><a class="reference internal" href="modules.html#ccnp-services">CCNP Services</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="modules.html#deployment-guide">Deployment Guide</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">CCNP Deployment Guide</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#create-td">Create TD</a></li>
<li class="toctree-l4"><a class="reference internal" href="#prepare-a-k8s-cluster-with-td-as-worker-nodes">Prepare a K8S cluster with TD as worker nodes</a></li>
<li class="toctree-l4"><a class="reference internal" href="#deploy-ccnp">Deploy CCNP</a></li>
<li class="toctree-l4"><a class="reference internal" href="#install-ccnp-sdk">Install CCNP SDK</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ccnp-example">CCNP example</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Confidential Cloud-Native Primitives</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="modules.html">Confidential Cloud-Native Primitives (CCNP)</a></li>
      <li class="breadcrumb-item active">CCNP Deployment Guide</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/_rst/deployment.readme.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="ccnp-deployment-guide">
<span id="readme"></span><h1>CCNP Deployment Guide<a class="headerlink" href="#ccnp-deployment-guide" title="Permalink to this heading">¶</a></h1>
<p>CCNP is designed for collecting confidential computing primitives in cloud native environments. It’s designed to run as DaemonSet on confidential virtual machines nodes, such as Intel Trust Domain (TD), in a Kubernetes cluster. Below diagram illustrates CCNP deployment process. In this document, it will use Intel TD as an example of CVM and deploy CCNP on Intel TD nodes.</p>
<a class="reference external image-reference" href="https://github.com/intel/confidential-cloud-native-primitives/blob/main/docs/ccnp-deployment-process.png"><img alt="Deployment diagram" src="../ccnp-deployment-process.png" /></a>
<section id="create-td">
<h2>Create TD<a class="headerlink" href="#create-td" title="Permalink to this heading">¶</a></h2>
<p>You can use <a class="reference external" href="https://github.com/intel/confidential-cloud-native-primitives/blob/main/tools/cvm-image-rewriter/README.md">cvm image rewriter</a> to prepare a TD enlightened guest image and start a TD using <a class="reference external" href="https://github.com/intel/confidential-cloud-native-primitives/blob/main/tools/cvm-image-rewriter/qemu-test.sh">qemu-test.sh</a>.</p>
</section>
<section id="prepare-a-k8s-cluster-with-td-as-worker-nodes">
<h2>Prepare a K8S cluster with TD as worker nodes<a class="headerlink" href="#prepare-a-k8s-cluster-with-td-as-worker-nodes" title="Permalink to this heading">¶</a></h2>
<p>You can either create a K8S cluster in the TD or let the TD join an existing K8S cluster. Please choose one of the following step to make sure the K8S cluster is prepared with the TD running in it. CCNP will be deployed on the TD later.</p>
<section id="option-1-create-a-k8s-cluster-on-the-td">
<h3>Option 1: Create a K8S cluster on the TD<a class="headerlink" href="#option-1-create-a-k8s-cluster-on-the-td" title="Permalink to this heading">¶</a></h3>
<p>After TDs are started, users need to setup a K8S cluster in the TDs. Please refer to the <a class="reference external" href="https://kubernetes.io/docs/home/">k8s official documentation</a> for detailed steps.</p>
<p><em>NOTE: If the cluster has only one node (master node), the taint on the node needs to be removed.</em></p>
</section>
<section id="option-2-add-the-td-to-an-existing-k8s-cluster">
<h3>Option 2: Add the TD to an existing K8S cluster<a class="headerlink" href="#option-2-add-the-td-to-an-existing-k8s-cluster" title="Permalink to this heading">¶</a></h3>
<p>TBD</p>
</section>
</section>
<section id="deploy-ccnp">
<h2>Deploy CCNP<a class="headerlink" href="#deploy-ccnp" title="Permalink to this heading">¶</a></h2>
<p>The following scripts can help to generate CCNP images and deploy them in the TD nodes.</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/intel/confidential-cloud-native-primitives/blob/main/container/build.sh">build.sh</a>: The tool will build docker images and push them to remote registry if required.</p></li>
<li><p><a class="reference external" href="https://github.com/intel/confidential-cloud-native-primitives/blob/main/deployment/script/deploy-ccnp.sh">deploy-ccnp.sh</a>: The tool will deploy CCNP services as DaemonSet on TDs in the K8S cluster.</p></li>
<li><p><a class="reference external" href="https://github.com/intel/confidential-cloud-native-primitives/blob/main/deployment/script/deploy-and-exec-ccnp-example.sh">deploy-and-exec-ccnp-example.sh</a>: The tool will deploy an example pod and show getting event logs, measurement and perform verification using CCNP in the pod.</p></li>
</ul>
<section id="prerequisite">
<h3>Prerequisite<a class="headerlink" href="#prerequisite" title="Permalink to this heading">¶</a></h3>
<ul class="simple">
<li><p>Install Helm on the TD nodes. Please refer to the <a class="reference external" href="https://helm.sh/docs/intro/quickstart/">HELM quick start</a>.</p></li>
<li><p>Install docker on the TD nodes. Please refer to <a class="reference external" href="https://docs.docker.com/get-docker/">Get Docker</a>.</p></li>
<li><p>Install python3-pip on the TD nodes. Please refer to <a class="reference external" href="https://pip.pypa.io/en/stable/installation/">pip document</a>.</p></li>
<li><p>Set access permission to TD device node and ccnp working directory on the TD nodes.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo mkdir -p /etc/udev/rules.d
$ sudo touch /etc/udev/rules.d/90-tdx.rules
# Check TD device node on TD
$ ls /dev/tdx*

# If above output is &quot;/dev/tdx-guest&quot;
$ sudo bash -c &#39;echo &quot;SUBSYSTEM==\&quot;misc\&quot;,KERNEL==\&quot;tdx-guest\&quot;,MODE=\&quot;0666\&quot;&quot;&gt;/etc/udev/rules.d/90-tdx.rules&#39;
# If above output is &quot;/dev/tdx_guest&quot;
$ sudo bash -c &#39;echo &quot;SUBSYSTEM==\&quot;misc\&quot;,KERNEL==\&quot;tdx_guest\&quot;,MODE=\&quot;0666\&quot;&quot;&gt;/etc/udev/rules.d/90-tdx.rules&#39;
# make the udev setup effective
$ sudo udevadm trigger

$ sudo touch /usr/lib/tmpfiles.d/ccnp.conf
$ sudo bash -c &#39;echo &quot;D /run/ccnp/uds 0757 - - -&quot;&gt;/usr/lib/tmpfiles.d/ccnp.conf&#39;
# make the directory setup effective by running below command or restarting the node
$ sudo systemd-tmpfiles --create
</pre></div>
</div>
</section>
<section id="build-ccnp-images">
<h3>Build CCNP images<a class="headerlink" href="#build-ccnp-images" title="Permalink to this heading">¶</a></h3>
<p>Run below scripts to generate CCNP images. It will generate 5 images and push them to user specific registry.</p>
<p><em>NOTE: The scripts need to run on a server with docker installed.</em></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cd container
$ sudo ./build.sh -r &lt;remote registry&gt; -g &lt;docker image tag&gt;

e.g.

# Build images with tag 0.3 and push them to remote registry test-registry.intel.com
$ sudo ./build.sh -r test-registry.intel.com/test -g 0.3

# Build images only with tag 0.3
$ sudo ./build.sh -a build -g 0.3
</pre></div>
</div>
<p><em>NOTE: please set ``HTTP_PROXY``, ``HTTPS_PROXY``, ``NO_PROXY`` in your terminal if they are needed in your environments.</em></p>
<p>After the script is successful, it’s supposed to see below docker images for CCNP.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo docker images
ccnp-node-measurement-example   &lt;your image tag&gt;
ccnp-eventlog-server            &lt;your image tag&gt;
ccnp-measurement-server         &lt;your image tag&gt;
ccnp-quote-server               &lt;your image tag&gt;
ccnp-device-plugin              &lt;your image tag&gt;
</pre></div>
</div>
</section>
<section id="deploy-ccnp-services">
<h3>Deploy CCNP services<a class="headerlink" href="#deploy-ccnp-services" title="Permalink to this heading">¶</a></h3>
<p>CCNP deployment tool will deploy TDX device plugin and DaemonSets for CCNP event log, measurement and quote.
Run below scripts on each TD node.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># Deploy CCNP with user specified remote registry and image tag
$ sudo ./deploy-ccnp.sh -r &lt;remote registry&gt; -g &lt;tag&gt;
e.g.
$ sudo ./deploy-ccnp.sh -r test-registry.intel.com/test -g 0.3

# Delete existing CCNP and Deploy CCNP with user specified remote registry and image tag
$ sudo ./deploy-ccnp.sh -r &lt;remote registry&gt; -g &lt;tag&gt; -d
</pre></div>
</div>
<p>After it’s successful, you should see helm release <code class="docutils literal notranslate"><span class="pre">ccnp-device-plugin</span></code> and 3 DaemonSets in namespace <code class="docutils literal notranslate"><span class="pre">ccnp</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo helm list
NAME                    NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                           APP VERSION
ccnp-device-plugin      default         1               2023-12-27 08:12:05.814766198 +0000 UTC deployed        ccnp-device-plugin-0.1.0        latest
$ sudo kubectl get ds -n ccnp
NAME                 DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR                                        AGE
eventlog-server      1         1         1       1            1           intel.feature.node.kubernetes.io/tdx-guest=enabled   24h
quote-server         1         1         1       1            1           intel.feature.node.kubernetes.io/tdx-guest=enabled   24h
measurement-server   1         1         1       1            1           intel.feature.node.kubernetes.io/tdx-guest=enabled   24h
$ sudo kubectl get pods -n ccnp
NAME                       READY   STATUS    RESTARTS      AGE
eventlog-server-bk2g5      1/1     Running   2 (39s ago)   24h
quote-server-6lhf6         1/1     Running   0             26s
measurement-server-4q9v7   1/1     Running   0             26s
</pre></div>
</div>
</section>
</section>
<section id="install-ccnp-sdk">
<h2>Install CCNP SDK<a class="headerlink" href="#install-ccnp-sdk" title="Permalink to this heading">¶</a></h2>
<p>There are two options to install CCNP SDK. <span class="raw-html-md"><br /></span>
Option 1: Users can run the following command on each work node to install CCNP client library for Python with PyPI.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">ccnp</span>
</pre></div>
</div>
<p>Option 2: Users can also run the following commands to install CCNP SDK from source code.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">confidential</span><span class="o">-</span><span class="n">cloud</span><span class="o">-</span><span class="n">native</span><span class="o">-</span><span class="n">primitives</span><span class="o">/</span><span class="n">sdk</span><span class="o">/</span><span class="n">python3</span><span class="o">/</span>
<span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">r</span> <span class="n">requirements</span><span class="o">.</span><span class="n">txt</span>
<span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">e</span> <span class="o">.</span>
</pre></div>
</div>
<p>At this step, CCNP has been installed successfully. For more detailed information, including SDK usage, please refer to <a class="reference external" href="https://intel.github.io/confidential-cloud-native-primitives/">here</a>.</p>
</section>
<section id="ccnp-example">
<h2>CCNP example<a class="headerlink" href="#ccnp-example" title="Permalink to this heading">¶</a></h2>
<p>The script <a class="reference external" href="https://github.com/intel/confidential-cloud-native-primitives/blob/main/deployment/script/deploy-and-exec-ccnp-example.sh">deploy-and-exec-ccnp-example.sh</a> is an example of using CCNP to collect event log, measurement and perform verification in a pod.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cd script
# Specify the registry name and tag used in image building
$ sudo ./deploy-and-exec-ccnp-example.sh -r &lt;remote-registry&gt; -g &lt;tag&gt;

# You can also specify which integrity measurement register (RTMR in the case of Intel TD) to verify
# e.g. Show RTMR[1] and RTMR[2] using below command
$ sudo ./deploy-and-exec-ccnp-example.sh -r &lt;remote-registry&gt; -g &lt;tag&gt; -i &#39;1 2&#39;
</pre></div>
</div>
<p>The example output of verification can be found at <a class="reference external" href="https://github.com/intel/confidential-cloud-native-primitives/blob/main/docs/sample-output-for-node-measurement-tool-full.txt">sample-output-for-node-measurement-tool-full.txt</a> and
<a class="reference external" href="https://github.com/intel/confidential-cloud-native-primitives/blob/main/docs/sample-output-for-node-measurement-tool-selected.txt">sample-output-for-node-measurement-tool-selected.txt</a></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="service.eventlog.html" class="btn btn-neutral float-left" title="Service: CCNP Eventlog Server" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Intel.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>
